{% extends 'base.html' %}
{% load static %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    /* Estilos Odontograma */
    .odontograma-container {
        background-color: #f8f9fa;
        min-height: calc(100vh - 100px);
        padding: 20px;
    }
    
    .tooth-container {
        display: inline-block;
        margin: 4px;
        text-align: center;
        width: 55px;
        cursor: pointer;
        transition: transform 0.2s;
        position: relative;
    }
    .tooth-container:hover {
        transform: scale(1.05);
        z-index: 10;
    }
    
    .tooth-svg {
        width: 100%;
        height: auto;
        filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.2));
    }
    
    .tooth-polygon {
        fill: #ffffff;
        stroke: #333;
        stroke-width: 1.5;
        transition: fill 0.1s;
    }
    .tooth-polygon:hover {
        fill: #e2e6ea;
        opacity: 0.8;
        stroke: #000;
    }
    
    /* Toolbar */
    .tool-btn {
        width: 100%;
        margin-bottom: 8px;
        text-align: left;
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        background: white;
        transition: all 0.2s;
    }
    .tool-btn:hover {
        background: #f1f3f5;
        transform: translateX(3px);
    }
    .tool-btn.active {
        background-color: #e7f5ff;
        border-color: #339af0;
        color: #1971c2;
        font-weight: 500;
        box-shadow: 0 0 0 2px rgba(51, 154, 240, 0.25);
    }
    .color-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 10px;
        border: 1px solid rgba(0,0,0,0.1);
    }

    /* Paneles Laterales */
    .sidebar-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        height: 100%;
        border: 1px solid #edf2f7;
    }
    .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #edf2f7;
        font-weight: 600;
        color: #2d3748;
    }
    .sidebar-content {
        padding: 15px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }

    /* Historial */
    .history-item {
        font-size: 0.85rem;
        padding: 8px 0;
        border-bottom: 1px dashed #edf2f7;
    }
    .history-time {
        color: #718096;
        font-size: 0.75rem;
    }

    /* Custom Tooltip */
    #tooth-tooltip {
        position: fixed;
        background: rgba(33, 37, 41, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        pointer-events: none;
        z-index: 9999;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        max-width: 200px;
    }

</style>

<div class="container-fluid odontograma-container">
    <div id="tooth-tooltip"></div>
    <div class="row g-3">
        
        <!-- COLUMNA IZQUIERDA: Herramientas -->
        <div class="col-md-2">
            <div class="sidebar-panel">
                <div class="sidebar-header bg-primary text-white rounded-top">
                    üõ†Ô∏è Herramientas
                </div>
                <div class="sidebar-content">
                    <p class="text-muted small fw-bold mb-2">ESTADOS B√ÅSICOS</p>
                    <button class="tool-btn active select-tool" data-state="CARIES" data-color="#ff4d4f">
                        <span class="color-dot" style="background: #ff4d4f;"></span> Caries
                    </button>
                    <button class="tool-btn select-tool" data-state="OBTURADO" data-color="#1890ff">
                        <span class="color-dot" style="background: #1890ff;"></span> Obturado
                    </button>
                    <button class="tool-btn select-tool" data-state="CORONA" data-color="#fadb14">
                        <span class="color-dot" style="background: #fadb14; border: 1px solid #d4b106;"></span> Corona
                    </button>
                    <button class="tool-btn select-tool" data-state="AUSENTE" data-color="#434343">
                        <span class="color-dot" style="background: #434343;"></span> Ausente (X)
                    </button>
                    <button class="tool-btn select-tool" data-state="ENDODONCIA" data-color="#eb2f96">
                        <span class="color-dot" style="background: #eb2f96;"></span> Endodoncia
                    </button>
                    <button class="tool-btn select-tool" data-state="SELLANTE" data-color="#52c41a">
                        <span class="color-dot" style="background: #52c41a;"></span> Sellante
                    </button>
                    <button class="tool-btn select-tool" data-state="SANO" data-color="#ffffff">
                        <span class="color-dot" style="background: #ffffff; border: 1px solid #ccc;"></span> Sano / Borrar
                    </button>

                    <p class="text-muted small fw-bold mt-3 mb-2">ORTODONCIA</p>
                    <button class="tool-btn select-tool" data-state="BRACKET" data-color="#722ed1">
                        <span class="color-dot" style="background: #722ed1;"></span> Bracket
                    </button>
                    <button class="tool-btn select-tool" data-state="RETENEDOR" data-color="#13c2c2">
                         <span class="color-dot" style="background: #13c2c2;"></span> Retenedor
                    </button>
                    <button class="tool-btn select-tool" data-state="APARATO_REMOVIBLE" data-color="#2f54eb">
                         <span class="color-dot" style="background: #2f54eb;"></span> Ap. Removible
                    </button>
                     <button class="tool-btn select-tool" data-state="EXTRACCION_PROGRAMADA" data-color="#fa541c">
                         <span class="color-dot" style="background: #fa541c;"></span> Ext. Programada
                    </button>

                    <p class="text-muted small fw-bold mt-3 mb-2">ADICIONALES</p>
                    <button class="tool-btn select-tool" data-state="FRACTURA" data-color="#cf1322">
                        <span class="color-dot" style="background: #cf1322;"></span> Fractura
                    </button>
                    <button class="tool-btn select-tool" data-state="IMPLANTE" data-color="#006d75">
                         <span class="color-dot" style="background: #006d75;"></span> Implante
                    </button>
                    <button class="tool-btn select-tool" data-state="PUENTE" data-color="#fa8c16">
                         <span class="color-dot" style="background: #fa8c16;"></span> Puente
                    </button>
                    <button class="tool-btn select-tool" data-state="PROTESIS_PARCIAL" data-color="#8c8c8c">
                         <span class="color-dot" style="background: #8c8c8c;"></span> Pr√≥tesis Parcial
                    </button>
                     <button class="tool-btn select-tool" data-state="PROTESIS_TOTAL" data-color="#595959">
                         <span class="color-dot" style="background: #595959;"></span> Pr√≥tesis Total
                    </button>
                    <button class="tool-btn select-tool" data-state="EN_ERUPCION" data-color="#a0d911">
                         <span class="color-dot" style="background: #a0d911;"></span> En Erupci√≥n
                    </button>
                    <button class="tool-btn select-tool" data-state="DIENTE_RETENIDO" data-color="#d4380d">
                         <span class="color-dot" style="background: #d4380d;"></span> Diente Retenido
                    </button>

                    <hr>
                    <button class="btn btn-success w-100 py-2 fw-bold shadow-sm" id="btn-save">
                        üíæ GUARDAR CAMBIOS
                    </button>
                    <button class="btn btn-danger w-100 py-2 fw-bold shadow-sm mt-2" id="btn-pdf">
                        üìÑ EXPORTAR PDF
                    </button>
                    <button class="btn btn-outline-secondary w-100 mt-2" id="btn-back">
                        ‚Üê Volver al Paciente
                    </button>
                </div>
            </div>
        </div>

        <!-- COLUMNA CENTRAL: Visualizaci√≥n -->
        <div class="col-md-7">
            <div class="sidebar-panel" id="capture-area">
                <div class="sidebar-header d-flex justify-content-between align-items-center">
                    <span>ü¶∑ Odontograma: <strong>{{ paciente.nombre }} {{ paciente.apellido }}</strong></span>
                    
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" id="view-adult">Adulto</button>
                        <button class="btn btn-outline-primary" id="view-child">Ni√±o</button>
                        <button class="btn btn-outline-primary" id="view-mixed">Mixta</button>
                    </div>
                </div>
                
                <div class="card-body bg-white text-center p-4" style="overflow-x: auto; min-height: 500px;">
                    
                                </div>
                            </div>
                        </div>

                        <!-- Mand√≠bula -->
                        <div class="row justify-content-center mt-5">
                            <div class="col-auto text-end border-end pe-3">
                                <div class="d-flex gap-1 justify-content-end">
                                    {% for i in "87654321" %}
                                        <div class="tooth-wrapper" data-tooth="4{{ i }}"></div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-auto text-start border-start ps-3">
                                <div class="d-flex gap-1 justify-content-start">
                                    {% for i in "12345678" %}
                                        <div class="tooth-wrapper" data-tooth="3{{ i }}"></div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VISTA NI√ëO -->
                    <div id="view-child-container" class="d-none mt-4">
                        <h6 class="text-muted mb-3">- Dentici√≥n Temporal -</h6>
                        <!-- Superior -->
                        <div class="row justify-content-center mb-4">
                            <div class="col-auto text-end border-end pe-3">
                                <div class="d-flex gap-1 justify-content-end">
                                    {% for i in "54321" %}
                                        <div class="tooth-wrapper" data-tooth="5{{ i }}"></div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-auto text-start border-start ps-3">
                                <div class="d-flex gap-1 justify-content-start">
                                    {% for i in "12345" %}
                                        <div class="tooth-wrapper" data-tooth="6{{ i }}"></div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Inferior -->
                        <div class="row justify-content-center">
                            <div class="col-auto text-end border-end pe-3">
                                <div class="d-flex gap-1 justify-content-end">
                                    {% for i in "54321" %}
                                        <div class="tooth-wrapper" data-tooth="8{{ i }}"></div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-auto text-start border-start ps-3">
                                <div class="d-flex gap-1 justify-content-start">
                                    {% for i in "12345" %}
                                        <div class="tooth-wrapper" data-tooth="7{{ i }}"></div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: Detalles e Historial -->
        <div class="col-md-3">
             <div class="sidebar-panel">
                <div class="sidebar-header">
                    üìã Detalle e Historial
                </div>
                <div class="sidebar-content">
                    <div class="alert alert-info py-2 small">
                        ‚ÑπÔ∏è <strong>Tip:</strong> Clic derecho para a√±adir nota r√°pida. Clic normal para pintar.
                    </div>
                    
                    <!-- Panel de Selecci√≥n Actual -->
                    <div id="selection-panel" class="d-none mb-4 p-3 bg-light rounded border">
                        <h6 class="mb-2 border-bottom pb-2">Diente <span id="selected-tooth-id" class="fw-bold text-primary">--</span></h6>
                        
                        <div id="dynamic-comments-list" class="mb-2" style="max-height: 200px; overflow-y: auto;">
                            <!-- Inputs generados din√°micamente -->
                        </div>

                        <div id="no-findings-msg" class="text-muted small text-center my-3 d-none">
                            Selecciona una herramienta y marca una cara.
                        </div>

                        <button class="btn btn-sm btn-primary w-100" id="btn-update-comment">
                            üíæ Guardar Notas
                        </button>
                    </div>

                    <!-- Lista de Hallazgos -->
                    <h6 class="small fw-bold text-uppercase text-muted border-bottom pb-2">Hallazgos Registrados</h6>
                    <div id="findings-list" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-muted text-center small mt-3">Sin hallazgos a√∫n.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template SVG Diente -->
<template id="tooth-template">
    <div class="tooth-container">
        <svg viewBox="0 0 100 140" class="tooth-svg">
            <polygon points="30,0 70,0 60,40 40,40" class="tooth-polygon" data-face="R" fill="#eee" />
            <g transform="translate(0,40)">
                <polygon points="0,0 100,0 80,20 20,20" class="tooth-polygon" data-face="V" />
                <polygon points="100,0 100,100 80,80 80,20" class="tooth-polygon" data-face="D" />
                <polygon points="100,100 0,100 20,80 80,80" class="tooth-polygon" data-face="L" />
                <polygon points="0,100 0,0 20,20 20,80" class="tooth-polygon" data-face="M" />
                <rect x="20" y="20" width="60" height="60" class="tooth-polygon" data-face="O" />
            </g>
            <!-- Badge Indicador de Comentario -->
            <circle cx="85" cy="15" r="8" fill="#1890ff" stroke="white" stroke-width="1" class="comment-badge" style="display: none;" />
            <text x="85" y="19" text-anchor="middle" fill="white" font-size="10" font-weight="bold" class="comment-badge" style="display: none;">i</text>
        </svg>
        <div class="small fw-bold mt-1 text-muted tooth-number" style="font-size: 10px;"></div>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const template = document.getElementById('tooth-template');
        const wrappers = document.querySelectorAll('.tooth-wrapper');
        const tooltip = document.getElementById('tooth-tooltip');
        
        // Initial Tool
        let currentTool = { state: 'CARIES', color: '#ff4d4f' };
        let hallazgosMap = {}; 
        let selectedToothId = null;
        
        // Mapa de nombres completos (Global Scope)
        const faceNames = {
            'V': 'Vestibular', 'L': 'Lingual', 'M': 'Mesial', 
            'D': 'Distal', 'O': 'Oclusal', 'R': 'Ra√≠z'
        };

        // 1. Initial Render (Clone SVG)
        wrappers.forEach(wrapper => {
            const toothId = wrapper.dataset.tooth;
            const clone = template.content.cloneNode(true);
            clone.querySelector('.tooth-number').textContent = toothId;
            
            const container = clone.querySelector('.tooth-container');
            
            // Interaction: Left Click
            container.addEventListener('click', () => {
                selectedToothId = toothId;
                updateSelectionPanel();
            });

            // Interaction: Context Menu (Right Click) -> Comment Focus
            container.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                selectedToothId = toothId;
                updateSelectionPanel();
                // Intentar enfocar el primer input si existe
                const firstInput = document.querySelector('.comment-input');
                if(firstInput) firstInput.focus();
            });

            // Interaction: Tooltip Hover
            container.addEventListener('mousemove', (e) => {
                const keys = Object.keys(hallazgosMap).filter(k => k.startsWith(`${toothId}-`));
                if (keys.length > 0) {
                    let content = `<strong>Diente ${toothId}</strong><br>`;
                    keys.forEach(k => {
                        const h = hallazgosMap[k];
                        content += `${h.state} (${k.split('-')[1]})`;
                        if(h.comment) content += `<br><em>"${h.comment}"</em>`;
                        content += `<br>`;
                    });
                    
                    tooltip.innerHTML = content;
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.pageX + 10) + 'px';
                    tooltip.style.top = (e.pageY + 10) + 'px';
                }
            });
            container.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });

            const polygons = clone.querySelectorAll('.tooth-polygon');
            polygons.forEach(poly => {
                poly.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectedToothId = toothId;
                    handleFaceClick(this, toothId); 
                    updateSelectionPanel();
                });
            });
            wrapper.appendChild(clone);
        });

        // Cargar Datos Iniciales
        const initialData = {{ hallazgos_json|safe }};
        if (initialData) {
            initialData.forEach(h => {
                const key = `${h.diente_id}-${h.cara}`;
                hallazgosMap[key] = { 
                    state: h.estado, 
                    comment: h.comentario || '',
                    creado_en: h.creado_en || ''
                };
                paintFace(h.diente_id, h.cara, h.estado);
            });
            renderFindingsList();
            updateIndicators();
        }

        // Tools Click
        document.querySelectorAll('.select-tool').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.select-tool').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTool = {
                    state: this.dataset.state,
                    color: this.dataset.color
                };
            });
        });

        // Views Switcher Logic
        document.getElementById('view-adult').addEventListener('click', () => toggleView('adult'));
        document.getElementById('view-child').addEventListener('click', () => toggleView('child'));
        document.getElementById('view-mixed').addEventListener('click', () => toggleView('mixed'));

        function toggleView(mode) {
            const adult = document.getElementById('view-adult-container');
            const child = document.getElementById('view-child-container');
            
            ['adult','child','mixed'].forEach(m => document.getElementById(`view-${m}`).classList.remove('active'));
            document.getElementById(`view-${mode}`).classList.add('active');

            if(mode==='adult') { adult.classList.remove('d-none'); child.classList.add('d-none'); }
            if(mode==='child') { adult.classList.add('d-none'); child.classList.remove('d-none'); }
            if(mode==='mixed') { adult.classList.remove('d-none'); child.classList.remove('d-none'); }
        }

        // Handle Face Click
        function handleFaceClick(element, toothId) {
            const face = element.dataset.face;
            const key = `${toothId}-${face}`;
            
            if (currentTool.state === 'AUSENTE' || currentTool.state === 'EXTRACCION_PROGRAMADA') {
                const allFaces = element.closest('.tooth-svg').querySelectorAll('.tooth-polygon');
                allFaces.forEach(f => {
                    const fKey = `${toothId}-${f.dataset.face}`;
                    hallazgosMap[fKey] = { 
                        state: currentTool.state, 
                        comment: hallazgosMap[fKey]?.comment || '',
                        creado_en: 'Ahora'
                    };
                    f.style.fill = currentTool.color;
                });
            } else if (currentTool.state === 'SANO') {
                delete hallazgosMap[key];
                element.style.fill = '#eee'; // Default para raiz
                if (face !== 'R') element.style.fill = '#fff'; // Default corona
            } else {
                hallazgosMap[key] = { 
                    state: currentTool.state, 
                    comment: hallazgosMap[key]?.comment || '',
                    creado_en: 'Ahora' // Marca temporal local
                };
                element.style.fill = currentTool.color;
            }
            renderFindingsList();
            updateIndicators();
        }

        // Helper Paint
        function paintFace(toothId, face, state) {
            const btn = document.querySelector(`.select-tool[data-state="${state}"]`);
            const color = btn ? btn.dataset.color : 'black';
            const toothEl = document.querySelector(`.tooth-wrapper[data-tooth="${toothId}"]`);
            if (!toothEl) return;
            const faceEl = toothEl.querySelector(`[data-face="${face}"]`);
            if (faceEl) faceEl.style.fill = color;
        }

        // Panel Update (Show Comment Form)
        function updateSelectionPanel() {
            document.getElementById('selection-panel').classList.remove('d-none');
            document.getElementById('selected-tooth-id').textContent = selectedToothId;
            
            const container = document.getElementById('dynamic-comments-list');
            container.innerHTML = '';
            
            const noMsg = document.getElementById('no-findings-msg');
            const keys = Object.keys(hallazgosMap).filter(k => k.startsWith(`${selectedToothId}-`));
            
            if (keys.length === 0) {
                noMsg.classList.remove('d-none');
                return;
            }
            noMsg.classList.add('d-none');

            // Mapa Global usado: faceNames

            // Generate Input for each finding
            keys.forEach(key => {
                const h = hallazgosMap[key];
                if (!key.includes('-')) return;
                
                const faceKey = key.split('-')[1];
                const faceName = faceNames[faceKey] || faceKey;
                
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-2 p-2 bg-white border rounded';
                
                wrapper.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="badge bg-secondary text-white small" style="font-size: 0.7rem;">${faceName}</span>
                        <span class="small fw-bold text-dark">${h.state}</span>
                    </div>
                    <input type="text" class="form-control form-control-sm comment-input" 
                           data-key="${key}" 
                           value="${h.comment || ''}" 
                           placeholder="Nota para ${faceKey}..."
                    >
                `;
                container.appendChild(wrapper);
            });
        }

        // Save Comment Local (Granular)
        document.getElementById('btn-update-comment').addEventListener('click', function() {
            if (!selectedToothId) return;
            
            const inputs = document.querySelectorAll('.comment-input');
            let updatedCount = 0;

            inputs.forEach(input => {
                const key = input.dataset.key;
                if (hallazgosMap[key]) {
                    if (hallazgosMap[key].comment !== input.value) {
                         hallazgosMap[key].comment = input.value;
                         updatedCount++;
                    }
                }
            });
            
            if (inputs.length === 0) {
                // Validaci√≥n para usuario: Si no hay inputs, es porque no hay hallazgos.
                // Intentar regenerar panel por si acaso
                updateSelectionPanel();
                const recheck = document.querySelectorAll('.comment-input');
                if (recheck.length === 0) {
                    alert('Primero marca alg√∫n estado en el diente.');
                    return;
                }
                // Si se regeneraron, continuar
            }
            
            updateIndicators(); 
            renderFindingsList(); 
            
            // Feedback subtle
            const btn = this;
            const originalText = btn.innerText;
            btn.innerText = '‚úÖ Guardado';
            setTimeout(() => btn.innerText = originalText, 1000);
        });

        // Update Indicators (Blue Badge)
        function updateIndicators() {
             document.querySelectorAll('.tooth-wrapper').forEach(wrapper => {
                const toothId = wrapper.dataset.tooth;
                const badges = wrapper.querySelectorAll('.comment-badge');
                // Check if any hallazgo for this tooth has comment
                const hasComment = Object.entries(hallazgosMap).some(([k, v]) => k.startsWith(`${toothId}-`) && v.comment);
                badges.forEach(b => b.style.display = hasComment ? 'block' : 'none');
             });
        }

        // Render List (Reverse Order)
        function renderFindingsList() {
            const container = document.getElementById('findings-list');
            container.innerHTML = '';
            
            const items = Object.entries(hallazgosMap);
            if (items.length === 0) {
                container.innerHTML = '<p class="text-muted text-center small mt-3">Sin hallazgos.</p>';
                return;
            }

            // Reverse for "Recent First" visual perception
            items.reverse().forEach(([key, val]) => {
                if (!key.includes('-')) return;
                const [tooth, faceKey] = key.split('-');
                const faceName = faceNames[faceKey] || faceKey;
                
                const div = document.createElement('div');
                div.className = 'history-item';
                
                let html = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>#${tooth}</strong> (${faceName}) - ${val.state}</span>
                        <small class="text-muted ms-2" style="font-size:0.7rem;">${val.creado_en || 'Reciente'}</small>
                    </div>
                `;
                if (val.comment) {
                    html += `<div class="text-muted small mt-1 bg-light p-1 rounded">üìù ${val.comment}</div>`;
                }
                
                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        // Guardado Refactorizado
        function saveOdontogram() {
            return new Promise((resolve, reject) => {
                const payload = [];
                for (const [key, val] of Object.entries(hallazgosMap)) {
                    const [tooth, face] = key.split('-');
                    payload.push({
                        tooth: tooth, face: face, state: val.state, comment: val.comment
                    });
                }
                
                fetch("{% url 'odontograma:guardar_odontograma' paciente.pk %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ hallazgos: payload })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'ok') resolve(data);
                    else reject(data.message);
                })
                .catch(err => reject('Error de red: ' + err));
            });
        }

        // Bot√≥n Guardar Manual
        document.getElementById('btn-save').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Guardando...';
            
            saveOdontogram()
            .then(() => {
                // Silent success visual feedback
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
                btn.textContent = '‚úÖ GUARDADO';
                setTimeout(() => {
                        btn.classList.add('btn-success');
                        btn.classList.remove('btn-outline-success');
                        btn.textContent = 'üíæ GUARDAR CAMBIOS';
                        btn.disabled = false;
                }, 2000);
            })
            .catch(err => {
                alert('Error al guardar: ' + err);
                btn.disabled = false;
            });
        });

        // Bot√≥n Volver (Auto-save)
        document.getElementById('btn-back').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Guardando y saliendo...';
            
            saveOdontogram()
            .then(() => {
                window.location.href = "{% url 'pacientes:detalle' paciente.pk %}";
            })
            .catch(err => {
                if(confirm('Hubo un error al guardar autom√°ticamente (' + err + '). ¬øDeseas salir sin guardar?')) {
                    window.location.href = "{% url 'pacientes:detalle' paciente.pk %}";
                } else {
                    btn.disabled = false;
                    btn.textContent = '‚Üê Volver al Paciente';
                }
            });
        });

        // PDF Export
        document.getElementById('btn-pdf').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Generando...';
            const element = document.getElementById('capture-area');
            
            html2canvas(element, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                fetch("{% url 'odontograma:exportar_pdf' paciente.pk %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ image: imgData })
                })
                .then(response => {
                    if (response.ok) return response.blob();
                    throw new Error('Error generando PDF');
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "Odontograma_{{ paciente.apellido }}.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    alert('PDF Generado Correctamente üìÑ');
                })
                .catch(err => {
                    console.error(err);
                    alert('Error al generar PDF: ' + err.message);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'üìÑ EXPORTAR PDF';
                });
            });
        });
    });
</script>
{% endblock %}
