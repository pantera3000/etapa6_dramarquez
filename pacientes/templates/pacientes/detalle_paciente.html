<!-- pacientes/templates/pacientes/detalle_paciente.html -->
{% extends 'base.html' %}
{% load static %}
{% load paciente_tags %}

{% block title %}{{ paciente.nombre_completo }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-center">
    <div class="col-lg-10">
        <!-- Header Hero & Dashboard - Redise√±o SaaS -->
        <style>
            /* --- Hero Section --- */
            .hero-card { background: white; border-radius: 1rem; box-shadow: 0 2px 12px rgba(0,0,0,0.04); border: 1px solid #e2e8f0; }
            .avatar-xl { 
                width: 80px; height: 80px; font-size: 2rem; font-weight: 700; border-radius: 1rem; 
                display: flex; align-items: center; justify-content: center; color: white;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
            
            /* --- Dashboard Cards --- */
            .dash-card { background: white; border-radius: 0.75rem; border: 1px solid #f1f5f9; height: 100%; transition: transform 0.2s; }
            .dash-card:hover { border-color: #cbd5e1; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
            .dash-header { 
                font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; 
                color: #64748b; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #f8fafc;
            }
            .info-row { display: flex; margin-bottom: 0.75rem; font-size: 0.9rem; align-items: baseline; }
            .info-label { width: 100px; flex-shrink: 0; color: #64748b; font-weight: 500; }
            .info-value { color: #0f172a; font-weight: 500; }
            
             /* --- Utility --- */
            .text-empty { color: #94a3b8; font-style: italic; font-size: 0.85rem; }
        </style>

        <!-- HERO SECTION -->
        <div class="hero-card p-4 mb-4">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-4">
                
                <!-- Profile Info -->
                <div class="d-flex align-items-center gap-4">
                    <div class="avatar-xl flex-shrink-0" style="background-color: {{ paciente.nombre_completo|avatar_color }};">
                        {{ paciente.nombre_completo|initials_avatar }}
                    </div>
                    <div>
                        <h1 class="h3 fw-bold mb-1 text-dark">{{ paciente.nombre_completo }}</h1>
                        <div class="d-flex flex-wrap align-items-center gap-2 text-muted small">
                            <span><i class="bi bi-person-vcard"></i> DNI: {{ paciente.dni }}</span>
                            <span>‚Ä¢</span>
                            <span>{{ paciente.edad }} a√±os</span>
                            {% if paciente.dias_hasta_cumple == 0 %}
                                <span class="badge bg-success bg-opacity-10 text-success border border-success px-2">üéÇ Cumplea√±os hoy</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-success btn-sm d-flex align-items-center gap-2 shadow-sm"
                            onclick="abrirModalWhatsApp('{{ paciente.telefono|default_if_none:''|escapejs }}', '{{ paciente.nombre_completo|escapejs }}', 'GENERAL')">
                        <i class="bi bi-whatsapp"></i> WhatsApp
                    </button>
                    <a href="{% url 'pacientes:editar' paciente.pk %}" class="btn btn-white border shadow-sm btn-sm text-dark">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    <a href="{% url 'pacientes:eliminar' paciente.pk %}" class="btn btn-white border shadow-sm btn-sm text-danger" onclick="return confirm('¬øEliminar paciente?')">
                        <i class="bi bi-trash"></i>
                    </a>
                    <a href="{% url 'pacientes:lista' %}" class="btn btn-light border btn-sm text-muted" 
                       onclick="if (document.referrer && document.referrer.includes(window.location.host)) { history.back(); return false; }">
                        <i class="bi bi-arrow-left"></i> Atr√°s
                    </a>
                </div>
            </div>
        </div>

        <!-- DASHBOARD GRID -->
        <div class="row g-3 mb-4">
            <!-- 1. Datos Personales Completos -->
            <div class="col-md-4">
                <div class="dash-card p-3">
                    <div class="dash-header"><i class="bi bi-person-lines-fill me-2"></i>Datos Personales</div>
                    
                    <div class="info-row">
                        <span class="info-label">Tel√©fono:</span>
                        <span class="info-value">
                            {% if paciente.telefono %}
                                <a href="tel:{{ paciente.telefono }}" class="text-decoration-none text-dark hover-link">{{ paciente.telefono }}</a>
                            {% else %}<span class="text-muted">‚Äî</span>{% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value text-truncate">
                            {% if paciente.email %}
                            <a href="mailto:{{ paciente.email }}" class="text-decoration-none text-dark">{{ paciente.email }}</a>
                            {% else %}<span class="text-muted">‚Äî</span>{% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Direcci√≥n:</span>
                        <span class="info-value">{{ paciente.direccion|default:"‚Äî" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Distrito:</span>
                        <span class="info-value">{{ paciente.distrito|default:"‚Äî" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fecha Nac.:</span>
                        <span class="info-value">{{ paciente.fecha_nacimiento|date:"d/m/Y" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">G√©nero:</span>
                        <span class="info-value">{{ paciente.get_genero_display }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Estado Civil:</span>
                        <span class="info-value">{{ paciente.get_estado_civil_display }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ocupaci√≥n:</span>
                        <span class="info-value">{{ paciente.ocupacion|default:"‚Äî" }}</span>
                    </div>
                    <!-- Datos Tutor -->
                    <div class="mt-3 pt-2 border-top">
                        <div class="info-row mb-1">
                            <span class="info-label fw-bold small text-uppercase" style="color:#94a3b8">Tutor / Apoderado</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Nombre:</span>
                            <span class="info-value">{{ paciente.nombre_tutor|default:"‚Äî" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tel√©fono:</span>
                            <span class="info-value">{{ paciente.telefono_tutor|default:"‚Äî" }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Antecedentes Cl√≠nicos -->
            <div class="col-md-4">
                <div class="dash-card p-3">
                    <div class="dash-header text-danger"><i class="bi bi-heart-pulse me-2"></i>Salud General</div>
                    
                    <div class="info-row">
                        <span class="info-label">Grupo Sang.:</span>
                        <span class="info-value badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-10">
                            {{ paciente.get_grupo_sanguineo_display|default:"‚Äî" }}
                        </span>
                    </div>

                    <div class="mb-3">
                        <label class="info-label w-100 mb-1">Alergias:</label>
                        {% if paciente.alergias %}
                            <div class="p-2 rounded bg-danger bg-opacity-10 text-danger border border-danger border-opacity-20 small">
                                ‚ö†Ô∏è {{ paciente.alergias }}
                            </div>
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </div>

                    <div>
                        <label class="info-label w-100 mb-1">Enfermedades Previas:</label>
                        {% if paciente.enfermedades_previas %}
                            <span class="info-value d-block p-2 bg-light rounded border small">{{ paciente.enfermedades_previas }}</span>
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 3. Historia Dental -->
            <div class="col-md-4">
                <div class="dash-card p-3">
                    <div class="dash-header text-primary"><i class="bi bi-tooth me-2"></i>Dental</div>
                    
                    <div class="mb-3">
                        <label class="info-label w-100 mb-1">Tratamientos Previos:</label>
                        <span class="info-value d-block small">
                            {{ paciente.tratamientos_previos|default:"‚Äî" }}
                        </span>
                    </div>

                    <div class="mb-3">
                        <label class="info-label w-100 mb-1">Experiencias Dentales:</label>
                        <span class="info-value d-block small">
                            {{ paciente.experiencias_dentales|default:"‚Äî" }}
                        </span>
                    </div>

                    <div class="mb-3">
                        <label class="info-label w-100 mb-1">Observaciones:</label>
                        <span class="info-value d-block small p-2 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded text-dark">
                             {{ paciente.observaciones|default:"Sin observaciones" }}
                        </span>
                    </div>

                    <div class="mt-auto pt-3 border-top">
                        <a href="{% url 'odontograma:ver_odontograma' paciente.pk %}" class="btn btn-outline-primary w-100 btn-sm">
                            <i class="bi bi-grid-3x3"></i> Ver Odontograma
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- Acciones movidas al Dashboard Grid y Header -->

        <!-- Pesta√±as de informaci√≥n relacionada -->
        <div class="bg-white rounded shadow-sm border">
            <ul class="nav nav-tabs" id="patientTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="historias-tab" data-bs-toggle="tab" data-bs-target="#historias" type="button">
                        üìö Historias ({{ paciente.entradas_historia.count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tratamientos-tab" data-bs-toggle="tab" data-bs-target="#tratamientos" type="button">
                        üí≥ Tratamientos ({{ paciente.tratamientos.count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="notas-tab" data-bs-toggle="tab" data-bs-target="#notas" type="button">
                        üìù Notas ({{ paciente.notas.count }})
                    </button>
                </li>
                {% if config.modulo_protocolos_activo %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="protocolos-tab" data-bs-toggle="tab" data-bs-target="#protocolos" type="button">
                        üìã Protocolo Ni√±os ({{ protocolos.count }})
                    </button>
                </li>
                {% endif %}
                {% if config.modulo_programa_salud_activo %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="programa-tab" data-bs-toggle="tab" data-bs-target="#programa" type="button">
                        üßò Programa Salud ({{ programas.count }})
                    </button>
                </li>
                {% endif %}

            </ul>

            <div class="tab-content p-3" id="patientTabsContent">
                <!-- Historias Cl√≠nicas - RESPONSIVE (SaaS Design) -->
                <div class="tab-pane fade" id="historias" role="tabpanel">
                    
                    <!-- Estilos espec√≠ficos de tablas SaaS (Repetidos para garantizar aislamiento/carga) -->
                    <style>
                        .table-saas thead th {
                            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;
                            color: #64748b; background-color: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 12px 16px;
                        }
                        .table-saas tbody td { vertical-align: middle; padding: 12px 16px; border-bottom: 1px solid #f1f5f9; }
                        .table-saas tbody tr:hover { background-color: #f1f5f9; cursor: pointer; }
                    </style>

                    <div class="d-flex justify-content-between align-items-center mb-4 pt-2">
                        <h5 class="mb-0 fw-bold text-dark">Historia Cl√≠nica</h5>
                        <a href="{% url 'historias:crear_entrada' paciente.pk %}" class="btn btn-primary btn-sm shadow-sm">
                            <i class="bi bi-plus-lg"></i> Nueva Consulta
                        </a>
                    </div>

                    {% if historias_paginadas %}
                        <!-- VISTA DE TABLA (Desktop) -->
                        <div class="d-none d-md-block border rounded-3 overflow-hidden">
                            <div class="table-responsive">
                                <table class="table table-saas mb-0">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Motivo</th>
                                            <th>Diagn√≥stico</th>
                                            <th class="text-end">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entrada in historias_paginadas %}
                                        <tr onclick="window.location='{% url 'historias:detalle_entrada' entrada.pk %}'">
                                            <td style="width: 15%;">
                                                <div class="d-flex flex-column">
                                                    <span class="fw-medium text-dark">{{ entrada.fecha|date:"d/m/Y" }}</span>
                                                    <small class="text-muted">{{ entrada.fecha|date:"H:i" }}</small>
                                                </div>
                                            </td>
                                            <td style="width: 30%;">
                                                <span class="fw-medium text-dark">{{ entrada.motivo }}</span>
                                                {% if entrada.imagenes.exists %}
                                                    <i class="bi bi-images text-primary ms-1" title="Im√°genes adjuntas"></i>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="text-muted small">{{ entrada.diagnostico|truncatewords:12|default:"Sin diagn√≥stico" }}</span>
                                            </td>
                                            <td class="text-end">
                                                <div class="d-flex gap-1 justify-content-end">
                                                    <a href="{% url 'historias:detalle_entrada' entrada.pk %}" class="btn btn-icon btn-sm text-info bg-light rounded-circle" title="Ver Detalle">
                                                        <i class="bi bi-eye-fill"></i>
                                                    </a>
                                                    <a href="{% url 'historias:eliminar_entrada' entrada.pk %}" 
                                                       class="btn btn-icon btn-sm text-danger bg-light rounded-circle"
                                                       onclick="event.stopPropagation(); return confirm('¬øEliminar entrada?')" title="Eliminar">
                                                        <i class="bi bi-trash-fill"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- VISTA M√ìVIL (Cards) -->
                        <div class="d-md-none">
                            {% for entrada in historias_paginadas %}
                            <div class="card mb-2 border shadow-sm" onclick="window.location='{% url 'historias:detalle_entrada' entrada.pk %}'">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <h6 class="fw-bold mb-0 text-dark">{{ entrada.motivo }}</h6>
                                        <small class="text-muted">{{ entrada.fecha|date:"d/m/Y" }}</small>
                                    </div>
                                    <p class="small text-muted mb-0 text-truncate">{{ entrada.diagnostico }}</p>
                                    {% if entrada.imagenes.exists %}
                                        <small class="text-primary mt-1 d-block"><i class="bi bi-images"></i> Im√°genes adjuntas</small>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Paginaci√≥n -->
                        {% if historias_paginadas.has_other_pages %}
                            <nav class="mt-4">
                                <ul class="pagination justify-content-center mb-0 pagination-sm">
                                    {% if historias_paginadas.has_previous %}
                                        <li class="page-item"><a class="page-link" href="?historias_page={{ historias_paginadas.previous_page_number }}">Anterior</a></li>
                                    {% endif %}
                                    <li class="page-item active"><span class="page-link">{{ historias_paginadas.number }}</span></li>
                                    {% if historias_paginadas.has_next %}
                                        <li class="page-item"><a class="page-link" href="?historias_page={{ historias_paginadas.next_page_number }}">Siguiente</a></li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}

                    {% else %}
                        <div class="text-center py-5 bg-light rounded border border-dashed">
                            <i class="bi bi-journal-medical text-muted fs-1 mb-2"></i>
                            <p class="text-muted mb-0">No hay historias cl√≠nicas registradas.</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Tratamientos - RESPONSIVE (SaaS Design) -->
                <div class="tab-pane fade" id="tratamientos" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4 pt-2">
                        <h5 class="mb-0 fw-bold text-dark">Tratamientos</h5>
                        <a href="{% url 'tratamientos:crear_tratamiento' paciente.pk %}" class="btn btn-success btn-sm shadow-sm">
                            <i class="bi bi-plus-lg"></i> Nuevo Tratamiento
                        </a>
                    </div>

                    {% if tratamientos_paginados %}
                        <!-- VISTA TABLE DESKTOP -->
                        <div class="d-none d-md-block border rounded-3 overflow-hidden">
                            <div class="table-responsive">
                                <table class="table table-saas mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 35%;">Tratamiento</th>
                                            <th style="width: 25%;">Progreso de Pago</th>
                                            <th style="width: 20%;">Estado</th>
                                            <th class="text-end">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for t in tratamientos_paginados %}
                                        <tr onclick="window.location='{% url 'tratamientos:detalle' t.pk %}'">
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <span class="d-block fw-bold text-dark mb-1">{{ t.nombre }}</span>
                                                    <div class="d-flex flex-wrap gap-2 small text-muted">
                                                        <span><i class="bi bi-calendar-event text-primary"></i> Inicio: {{ t.fecha_inicio|date:"d/m/Y" }}</span>
                                                        {% if t.fecha_fin %}
                                                            <span><i class="bi bi-calendar-check text-success"></i> Fin: {{ t.fecha_fin|date:"d/m/Y" }}</span>
                                                        {% endif %}
                                                    </div>
                                                    {% if t.duracion_dias %}
                                                        <small class="text-muted mt-1">
                                                            <i class="bi bi-clock-history"></i> Duraci√≥n: {{ t.duracion_dias }} d√≠a{{ t.duracion_dias|pluralize }}
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <span class="fw-bold text-dark font-monospace small">S/ {{ t.total_pagado|floatformat:2 }}</span>
                                                        <span class="text-muted small">de S/ {{ t.costo_total|floatformat:2 }}</span>
                                                    </div>
                                                    <!-- Barra de progreso -->
                                                    <div class="progress" style="height: 8px;">
                                                        <div class="progress-bar {% if t.porcentaje_pagado >= 100 %}bg-success{% elif t.porcentaje_pagado >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                             role="progressbar" 
                                                             style="width: {{ t.porcentaje_pagado }}%;" 
                                                             aria-valuenow="{{ t.porcentaje_pagado }}" 
                                                             aria-valuemin="0" 
                                                             aria-valuemax="100">
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                                        <small class="{% if t.deuda > 0 %}text-danger fw-bold{% else %}text-success{% endif %}">
                                                            {% if t.deuda > 0 %}
                                                                <i class="bi bi-exclamation-circle"></i> Debe: S/ {{ t.deuda|floatformat:2 }}
                                                            {% else %}
                                                                <i class="bi bi-check-circle-fill"></i> Pagado
                                                            {% endif %}
                                                        </small>
                                                        <small class="text-muted">{{ t.porcentaje_pagado }}%</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ t.clase_estado_pago }} rounded-pill px-3 py-2">
                                                    {% if t.estado == 'pendiente' %}
                                                        <i class="bi bi-hourglass"></i>
                                                    {% elif t.estado == 'en_progreso' %}
                                                        <i class="bi bi-arrow-repeat"></i>
                                                    {% else %}
                                                        <i class="bi bi-check-circle-fill"></i>
                                                    {% endif %}
                                                    {{ t.get_estado_display }}
                                                </span>
                                                {% if t.deuda == 0 and t.estado != 'completado' %}
                                                    <div class="mt-1">
                                                        <small class="badge bg-warning bg-opacity-10 text-warning border border-warning">
                                                            <i class="bi bi-exclamation-triangle"></i> Listo para completar
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                <div class="d-flex gap-1 justify-content-end">
                                                    <a href="{% url 'tratamientos:crear_pago' t.pk %}" class="btn btn-icon btn-sm text-success bg-light rounded-circle" title="Registrar Pago">
                                                        <i class="bi bi-cash-coin"></i>
                                                    </a>
                                                    <a href="{% url 'tratamientos:detalle' t.pk %}" class="btn btn-icon btn-sm text-info bg-light rounded-circle" title="Ver">
                                                        <i class="bi bi-eye-fill"></i>
                                                    </a>
                                                    <a href="{% url 'tratamientos:editar' t.pk %}" class="btn btn-icon btn-sm text-warning bg-light rounded-circle" title="Editar">
                                                        <i class="bi bi-pencil-fill"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- VISTA MOVIL -->
                        <div class="d-md-none">
                            {% for t in tratamientos_paginados %}
                            <div class="card mb-3 border shadow-sm" onclick="window.location='{% url 'tratamientos:detalle' t.pk %}'">
                                <div class="card-body p-3">
                                    <!-- Header -->
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="fw-bold mb-0 text-dark">{{ t.nombre }}</h6>
                                        <span class="badge bg-{{ t.clase_estado_pago }} px-2 py-1">
                                            {% if t.estado == 'pendiente' %}‚è≥{% elif t.estado == 'en_progreso' %}üîÑ{% else %}‚úÖ{% endif %}
                                            {{ t.get_estado_display }}
                                        </span>
                                    </div>
                                    
                                    <!-- Fechas -->
                                    <div class="d-flex flex-column gap-1 small text-muted mb-2">
                                        <span><i class="bi bi-calendar-event text-primary"></i> Inicio: {{ t.fecha_inicio|date:"d/m/Y" }}</span>
                                        {% if t.fecha_fin %}
                                            <span><i class="bi bi-calendar-check text-success"></i> Fin: {{ t.fecha_fin|date:"d/m/Y" }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Progreso de Pago -->
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Progreso de Pago</small>
                                            <small class="fw-bold">{{ t.porcentaje_pagado }}%</small>
                                        </div>
                                        <div class="progress mb-2" style="height: 10px;">
                                            <div class="progress-bar {% if t.porcentaje_pagado >= 100 %}bg-success{% elif t.porcentaje_pagado >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ t.porcentaje_pagado }}%;">
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <small class="text-muted d-block">Costo: <span class="fw-bold text-dark">S/ {{ t.costo_total|floatformat:2 }}</span></small>
                                                {% if t.deuda > 0 %}
                                                    <small class="text-danger fw-bold"><i class="bi bi-exclamation-circle"></i> Debe: S/ {{ t.deuda|floatformat:2 }}</small>
                                                {% else %}
                                                    <small class="text-success"><i class="bi bi-check-circle-fill"></i> Pagado</small>
                                                {% endif %}
                                            </div>
                                            {% if t.deuda == 0 and t.estado != 'completado' %}
                                                <small class="badge bg-warning bg-opacity-10 text-warning border border-warning">
                                                    <i class="bi bi-exclamation-triangle"></i> Listo
                                                </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Paginaci√≥n Tratamientos -->
                         {% if tratamientos_paginados.has_other_pages %}
                            <nav class="mt-4">
                                <ul class="pagination justify-content-center mb-0 pagination-sm">
                                    {% if tratamientos_paginados.has_previous %}
                                        <li class="page-item"><a class="page-link" href="?tratamientos_page={{ tratamientos_paginados.previous_page_number }}">Anterior</a></li>
                                    {% endif %}
                                    <li class="page-item active"><span class="page-link">{{ tratamientos_paginados.number }}</span></li>
                                    {% if tratamientos_paginados.has_next %}
                                        <li class="page-item"><a class="page-link" href="?tratamientos_page={{ tratamientos_paginados.next_page_number }}">Siguiente</a></li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5 bg-light rounded border border-dashed">
                            <i class="bi bi-clipboard2-pulse text-muted fs-1 mb-2"></i>
                            <p class="text-muted mb-0">No hay tratamientos registrados.</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Notas - RESPONSIVE (SaaS Design) -->
                <div class="tab-pane fade" id="notas" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4 pt-2">
                        <h5 class="mb-0 fw-bold text-dark">Notas</h5>
                        <a href="{% url 'notas:crear_para_paciente' paciente.pk %}" class="btn btn-secondary btn-sm shadow-sm">
                            <i class="bi bi-plus-lg"></i> Nueva Nota
                        </a>
                    </div>
                    
                    {% if notas_paginadas %}
                        <!-- VISTA DESKTOP -->
                        <div class="d-none d-md-block border rounded-3 overflow-hidden">
                             <div class="table-responsive">
                                <table class="table table-saas mb-0">
                                    <thead>
                                        <tr>
                                            <th>T√≠tulo</th>
                                            <th>Contenido</th>
                                            <th>Fecha</th>
                                            <th class="text-end">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for nota in notas_paginadas %}
                                        <tr onclick="window.location='{% url 'notas:detalle' nota.pk %}'">
                                            <td>
                                                <span class="fw-bold text-dark">{{ nota.titulo }}</span>
                                                {% if nota.imagenes.exists %}
                                                     <i class="bi bi-paperclip text-muted ms-1"></i>
                                                {% endif %}
                                            </td>
                                            <td class="text-muted small">{{ nota.contenido|truncatewords:12 }}</td>
                                            <td class="text-muted small">{{ nota.creado_en|date:"d/m/Y" }}</td>
                                            <td class="text-end">
                                                <div class="d-flex gap-1 justify-content-end">
                                                    <a href="{% url 'notas:detalle' nota.pk %}" class="btn btn-icon btn-sm text-info bg-light rounded-circle" title="Ver"><i class="bi bi-eye-fill"></i></a>
                                                    <a href="{% url 'notas:eliminar' nota.pk %}" 
                                                       class="btn btn-icon btn-sm text-danger bg-light rounded-circle"
                                                       onclick="event.stopPropagation(); return confirm('¬øEliminar nota?')" title="Eliminar">
                                                        <i class="bi bi-trash-fill"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                         <!-- VISTA MOVIL -->
                         <div class="d-md-none">
                            {% for nota in notas_paginadas %}
                            <div class="card mb-2 border shadow-sm" onclick="window.location='{% url 'notas:detalle' nota.pk %}'">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <h6 class="fw-bold mb-0 text-dark">{{ nota.titulo }}</h6>
                                        <small class="text-muted">{{ nota.creado_en|date:"d/m" }}</small>
                                    </div>
                                    <p class="small text-muted mb-0 text-truncate">{{ nota.contenido }}</p>
                                </div>
                            </div>
                            {% endfor %}
                         </div>

                        <!-- Paginaci√≥n Notas -->
                        {% if notas_paginadas.has_other_pages %}
                            <nav class="mt-4">
                                <ul class="pagination justify-content-center mb-0 pagination-sm">
                                    {% if notas_paginadas.has_previous %}
                                        <li class="page-item"><a class="page-link" href="?notas_page={{ notas_paginadas.previous_page_number }}">Anterior</a></li>
                                    {% endif %}
                                    <li class="page-item active"><span class="page-link">{{ notas_paginadas.number }}</span></li>
                                    {% if notas_paginadas.has_next %}
                                        <li class="page-item"><a class="page-link" href="?notas_page={{ notas_paginadas.next_page_number }}">Siguiente</a></li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}

                    {% else %}
                        <div class="text-center py-5 bg-light rounded border border-dashed">
                            <i class="bi bi-sticky text-muted fs-1 mb-2"></i>
                            <p class="text-muted mb-0">No hay notas registradas.</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Protocolo Ni√±os -->
                {% if config.modulo_protocolos_activo %}
                <div class="tab-pane fade" id="protocolos" role="tabpanel">
                    {% include 'protocolos/lista_protocolos.html' %}
                </div>
                {% endif %}

                <!-- Programa Salud -->
                {% if config.modulo_programa_salud_activo %}
                <div class="tab-pane fade" id="programa" role="tabpanel">
                    {% include 'programa_salud/lista_programas.html' %}
                </div>
                {% endif %}
                

            </div>
        </div>
    </div>
</div>

<!-- Script para mantener la pesta√±a activa -->
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    let activeTab = 'historias-tab'; // Por defecto

    if (urlParams.has('tratamientos_page')) {
        activeTab = 'tratamientos-tab';
    } else if (urlParams.has('notas_page')) {
        activeTab = 'notas-tab';
    } else if (urlParams.has('historias_page')) {
        activeTab = 'historias-tab';
    } else if (urlParams.has('protocolos_page')) {
        activeTab = 'protocolos-tab';
    } else if (urlParams.has('programa_page')) {
        activeTab = 'programa-tab';
    }

    const tabButton = document.querySelector('#' + activeTab);
    if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
    }
});
</script>
{% endblock %}
{% endblock %}